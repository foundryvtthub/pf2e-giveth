(()=>{"use strict";let t="";function e(e){game.socket.emit(`module.${t}`,e)}function n(t,e){const n=Hooks.on(t,e),o=Hooks.events[t].findIndex((t=>t.id===n));if(0!==o){const[e]=Hooks.events[t].splice(o,1);Hooks.events[t].unshift(e)}}function o(...e){return`${t}.settings.${e.join(".")}`}function i(...e){let[n,o]=e;return n=`${t}.${n}`,o?game.i18n.format(n,o):game.i18n.localize(n)}class MoveLootPopup extends FormApplication{onSubmitCallback;constructor(t,e,n){super(t,e),this.onSubmitCallback=n}async getData(){const[t,e]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),maxQuantity:this.options.maxQuantity,newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:e}}static get defaultOptions(){return{...super.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",maxQuantity:1,newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,e){this.onSubmitCallback(e.quantity,e.newStack)}}function s(t,n,o,s){const r=t.id,c=n.id,u=!(o instanceof Item);if(!u&&o.isOfType("physical")){const e=o.quantity;if(e<1)return function(...t){const[e,n,o]=t;!function(t,e,n,o){const s="string"==typeof e?e:"info",a="object"==typeof e?e:"object"==typeof n?n:void 0,r="boolean"==typeof e?e:"boolean"==typeof n?n:o??!1;ui.notifications.notify(i(t,a),s,{permanent:r})}(e,"warning",n,o)}("notification.zero");if(1===e)return a(r,c,o.id,1,!1);new MoveLootPopup(t,{maxQuantity:e,lockStack:!1,isPurchase:!1},((t,e)=>{a(r,c,o.id,t,e)})).render(!0)}else{const t=u?`Compendium.${o.pack}.${o._id}`:o.uuid;"condition"===o.type?e({type:"giveth-condition",targetId:c,value:s??1,uuid:t}):e({type:"giveth-effect",targetId:c,uuid:t})}}function a(t,n,o,i,s){e({type:"giveth-physical",ownerId:t,targetId:n,itemId:o,qty:i,stack:s})}function r(t){if(t.tokenId||"Item"!==t.type||!t.uuid)return;const e=t.actorId??t.context?.origin.actor.split(".").at(-1);if(!e)return;const n=game.actors.get(e);if(!c(n)||!n.isOwner)return;const o=fromUuidSync(t.uuid);if(!o)return;const i=!(o instanceof Item);return i&&o.pack&&["effect","condition"].includes(o.type)||!i&&o.isOfType("physical","effect")?{actor:n,item:o,value:t.value}:void 0}function c(t,e){return!(!t||e&&t.id===e)&&t.hasPlayerOwner&&!t.isToken&&t.isOfType("character","npc","vehicle")}function u(){return game.users.some((t=>t.active&&t.isGM))}function p(t,e){if(!u())return!0;const n=r(e);if(!n)return!0;const o=t.tokens.placeables.slice().filter((t=>{if(!t.document.actorLink)return!1;const n=t.actor;if(!c(n,e.actorId)||n.isOwner)return!1;const o=t.x+(t.hitArea?.right??0),i=t.y+(t.hitArea?.bottom??0);return e.x>=t.x&&e.y>=t.y&&e.x<=o&&e.y<=i})).sort(((t,e)=>e.document.sort-t.document.sort)).at(0)?.actor;return!o||(s(n.actor,o,n.item,n.value),!1)}function d(t,e,n){if(!u()||t.isOwner||!c(t,n.actorId))return!0;const o=r(n);return!o||(s(o.actor,t,o.item,o.value),!1)}const f=new Map;f.set(-1,13),f.set(0,14),f.set(1,15),f.set(2,16),f.set(3,18),f.set(4,19),f.set(5,20),f.set(6,22),f.set(7,23),f.set(8,24),f.set(9,26),f.set(10,27),f.set(11,28),f.set(12,30),f.set(13,31),f.set(14,32),f.set(15,34),f.set(16,35),f.set(17,36),f.set(18,38),f.set(19,39),f.set(20,40),f.set(21,42),f.set(22,44),f.set(23,46),f.set(24,48),f.set(25,50);const l=new Map;l.set("incredibly easy",-10),l.set("very easy",-5),l.set("easy",-2),l.set("normal",0),l.set("hard",2),l.set("very hard",5),l.set("incredibly hard",10),new Set(["arcane","divine","occult","primal"]);const m=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,g=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,y=(new RegExp(g,"gu"),String.raw`(?:${m})(?=${g})|(?:${g})(?=${m})`),h=String.raw`(?:${m})(?=${m})`,k=String.raw`\p{Lowercase_Letter}`,v=String.raw`\p{Uppercase_Letter}`;new RegExp(`(${k})(${v}${h})`,"gu"),new RegExp(`${v}|(?:${y})${k}`,"gu");const w=new Set(["armor","backpack","book","consumable","equipment","treasure","weapon"]);async function b({itemId:e,ownerId:n,qty:o,stack:s,targetId:a}){const r=game.actors.get(n),c=game.actors.get(a);if(!r||!c)return;const u=r.items.get(e);if(!u)return;o=Math.min(o,u.quantity);const p=u.quantity-o,d=u.toObject();var f;d.system.quantity=o,d.system.equipped.carryType="worn",function(t){return e=w,n=t.type,e.has(n);var e,n}(f=d)&&"invested"in f.system.equipped&&(d.system.equipped.invested=!u.traits.has("invested")&&null);const l=await c.addToInventory(d,void 0,s);if(!l)return;if(p<1?u.delete():u.update({"system.quantity":p}),"message",!game.settings.get(t,"message"))return;let m=l.isIdentified?`@UUID[${l.uuid}]`:function(t){return`<span style="background: #DDD;\n    padding: 1px 4px;\n    border: 1px solid var(--color-border-dark-tertiary);\n    border-radius: 2px;\n    white-space: nowrap;\n    word-break: break-all;">${t}</span>`}(l.name);o>1&&(m+=` x${o}`),ChatMessage.create({flavor:`<h4 class="action">${i("giveth",{target:c.name})}</h4>`,content:m,speaker:ChatMessage.getSpeaker({actor:r})})}function $(t){(function(){if(!game.user.isGM)return!1;const t=game.users.find((t=>t.active&&t.isGM));return game.user===t})()&&("giveth-condition"===t.type?async function({targetId:t,uuid:e,value:n}){const o=game.actors.get(t);if(!o)return;const i=await fromUuid(e);i&&o.increaseCondition(i.slug,{min:n})}(t):"giveth-effect"===t.type?async function({targetId:t,uuid:e}){const n=game.actors.get(t);if(!n)return;const o=await fromUuid(e);if(!o)return;const i=o.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[i])}(t):b(t))}t||(t="pf2e-giveth"),Hooks.once("init",(()=>{!function(e){const n=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=o(n,"name"),e.hint=o(n,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce(((t,e)=>(t[e]=o(n,"choices",e),t)),{})),game.settings.register(t,n,e)}({name:"message",type:Boolean,default:!0,config:!0})})),Hooks.once("ready",(()=>{var e;game.user.isGM?(e=$,game.socket.on(`module.${t}`,e)):(n("dropCanvasData",p),n("dropActorSheetData",d))}))})();
//# sourceMappingURL=main.js.map